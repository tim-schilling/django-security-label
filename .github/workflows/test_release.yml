name: Test Python üêç distribution üì¶ to TestPyPI

on:
  workflow_dispatch:
    inputs:
      iteration:
        description: 'A unique iteration for the run. The tag will be suffixed with .devyyyymmdd<iteration>'
        type: string
        required: true
        default: "0"
  schedule:
    # Run the second day of every month.
    - cron: "12 3 2 * *"
  push:
    tags:
      - '*'

permissions: {}

env:
  # Change these for your project's URLs
  PYPI_TEST_URL: https://test.pypi.org/p/django-security-label
  # The environment key that overrides the version number
  DEV_VERSION_ENV_KEY: DSL_VERSION_DEV

jobs:
  create-dev-version:
    # Generate the dev version suffix based on the current date.
    # Tag name:
    #   <version>.dev<yyyymmdd><iteration>
    name: Create dev version string
    runs-on: ubuntu-latest
    outputs:
      dev_version: ${{ steps.output-dev-version.outputs.dev_version }}
    steps:
      - name: Set date suffix
        id: set-date
        run: echo "suffix=dev$(date +%Y%m%d)" >> $GITHUB_ENV
      - name: Determine Iteration Value
        id: set-iteration
        # If the action is running on a schedule, default iteration to 0
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "iteration=${GITHUB_EVENT_INPUTS_ITERATION}" >> $GITHUB_ENV
          else
            echo "iteration=0" >> $GITHUB_ENV
          fi
        env:
          GITHUB_EVENT_INPUTS_ITERATION: ${{ github.event.inputs.iteration }}
      - name: Output dev version
        id: output-dev-version
        # Don't output a dev version if the push was for a tag.
        run: |
          if [[ "${{ startsWith(github.ref, 'refs/tags') }}" == "true" ]]; then
            echo "dev_version=" >> "$GITHUB_OUTPUT"
          else
            echo "dev_version=${SUFFIX}${ITERATION}" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: Build distribution üì¶
    needs:
    - create-dev-version
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
      with:
        persist-credentials: false
    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6
      with:
        python-version: "3.x"
    - name: Install pypa/build
      run:
        python3 -m pip install build --user
    - name: Build a binary wheel and a source tarball
      env:
        DEV_VERSION: ${{needs.create-dev-version.outputs.dev_version}}
      run: ${{ env.DEV_VERSION_ENV_KEY }}="${DEV_VERSION}" python3 -m build
    - name: Store the distribution packages
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4  # v5
      with:
        name: python-package-distributions
        path: dist/

  publish-to-testpypi:
    name: Publish Python üêç distribution üì¶ to TestPyPI
    needs:
    - build
    runs-on: ubuntu-latest

    environment:
      name: testpypi
      url: ${{ env.PYPI_TEST_URL }}

    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing

    steps:
    - name: Download all the dists
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53  # v6
      with:
        name: python-package-distributions
        path: dist/
    - name: Publish distribution üì¶ to TestPyPI
      uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e  # release/v1.13
      with:
        repository-url: https://test.pypi.org/legacy/
        skip-existing: true
